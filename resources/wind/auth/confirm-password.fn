(shield::validate
	(shield::field token
		required: true
		pattern: uuid
	)
)

(set user_id (call 'lib.directives.user_id' type: 'auth_new_password_token' value: (token)))

(content-type 'text/html')

(if (isnull (this.user_id))
	(return (expand (strings.@page_err_token))))

(call 'lib.directives.delete' user_id: (user_id) type: 'auth_new_password_token')

(db::exec `UPDATE ##users SET password={escape {call 'lib.directives.string' user_id: {user_id} type: 'auth_new_password'}} WHERE user_id={user_id}`)

(return (expand (strings.@page_password_confirmed))))
