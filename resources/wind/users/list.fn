(sentinel::privilege-required admin)

(call '@filters')

(return (db::table `
	SELECT
		x.user_id as id,
		x.created,
		x.is_authorized,
		x.username,
		x.name,
		GROUP_CONCAT(p.privilege_id) as privileges,
		GROUP_CONCAT(p.name) as s_privileges

	FROM ##users x
	LEFT JOIN ##user_privileges upr ON upr.user_id=x.user_id
	LEFT JOIN ##privileges p ON p.privilege_id=upr.privilege_id

	WHERE x.is_active=1 {filters}

	GROUP BY x.user_id
	LIMIT {count} OFFSET {offset}
`))
